<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Mega Monopoly 5 - Stock</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
		<main class="container">
    <h1 id="stockTicker">Stock</h1>
    <div class="top-row"><a href="/" id="backLink" class="back-link">← Back</a></div>

    <p>Welcome, <strong id="u">?</strong></p>
    <p>It is <strong id="t">-</strong></p>
    <p>Balance: <strong id="bal">-</strong></p>

    <p>Holdings: <strong id="holdingsLine">-</strong></p>
    <p>Market value: <strong id="marketValue">-</strong></p>
    <p>Net worth: <strong id="netWorth">-</strong></p>

    <hr>

    <p><strong id="stockName">-</strong></p>
    <p>Industry: <span id="stockIndustry">-</span></p>
    <p>
      Price: <span id="stockPrice">-</span>
      <span id="stockChange" class=""></span>
    </p>

    <div class="chart-card"><div id="chart" style="width: 100%; height: 360px;"></div></div>

    <div class="trade">
	<div class="row"><label>
	  Quantity:
	  <input id="tradeQty" type="number" min="0" step="1" value="0" />
	</label>
	<button id="buyBtn" class="btn primary" type="button">Buy</button>
	<button id="sellBtn" class="btn" type="button">Sell</button>
	<span id="tradeMsg" class="msg"></span></div>
	
	<div class="sub">
	  <div>You have: <strong id="youHaveShares">-</strong></div>
	  <div>Transaction: <strong id="txnValue">-</strong></div>
	</div>
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      const username = params.get("username") || "";
      const symbol = params.get("stock") || ""; // dashboard uses ?stock=TICKER

      let latestBalance = 0;
      let latestStocksBySymbol = {};
      let latestStockPrice = null;
      let latestYouHave = 0;

      document.getElementById("u").textContent = username || "?";
      document.getElementById("stockTicker").textContent = symbol || "Stock";

      const back = document.getElementById("backLink");
      back.href = username ? `/dashboard.html?username=${encodeURIComponent(username)}` : "/";

      function fmtMoney(x) {
        if (typeof x !== "number" || !isFinite(x)) return "-";
        return `$${x.toFixed(2)}`;
      }

      function fmtChange(price, prev) {
        if (typeof price !== "number" || typeof prev !== "number" || !isFinite(price) || !isFinite(prev) || prev === 0) {
          return { text: "", cls: "" };
        }
        const pct = ((price - prev) / prev) * 100;
        const up = pct >= 0;
        const arrow = up ? "⌃" : "⌄";
        return { text: ` ${arrow} ${Math.abs(pct).toFixed(1)}%`, cls: up ? "stock-change up" : "stock-change down" };
      }


      function updateTxnLine() {
        const qtyRaw = document.getElementById("tradeQty")?.value;
        const qty = parseInt(qtyRaw, 10);

        const txnEl = document.getElementById("txnValue");
        if (!txnEl) return;

        const p = (typeof latestStockPrice === "number" && isFinite(latestStockPrice)) ? latestStockPrice : null;
        if (!Number.isFinite(qty) || qty <= 0 || p === null) {
          txnEl.textContent = "$0.00";
          return;
        }
        txnEl.textContent = fmtMoney(p * qty);
      }

      async function loadUser() {
        if (!username) return;

        const r = await fetch(`/user?username=${encodeURIComponent(username)}`);
        const j = await r.json();

        if (j.ok) {
          document.getElementById("bal").textContent = j.balance;
          latestBalance = Number(j.balance) || 0;
          document.getElementById("t").textContent = j.time_string;
        } else {
          document.getElementById("bal").textContent = "unknown";
          document.getElementById("t").textContent = "-";
        }
      }


      function setTradeMsg(text, ok) {
        const el = document.getElementById("tradeMsg");
        if (!el) return;
        el.textContent = text || "";
        el.style.color = ok ? "green" : "crimson";
      }

      async function loadAllStocks() {
        const r = await fetch("/stocks");
        const j = await r.json();
        if (!j.ok || !Array.isArray(j.stocks)) return;
        latestStocksBySymbol = {};
        for (const s of j.stocks) latestStocksBySymbol[s.symbol] = s;
      }

      async function loadPortfolioSummary() {
        const holdingsEl = document.getElementById("holdingsLine");
        const mvEl = document.getElementById("marketValue");
        const nwEl = document.getElementById("netWorth");
        if (!holdingsEl || !mvEl || !nwEl) return;
        if (!username) return;

        let holdings = [];
        try {
          const r = await fetch(`/holdings?username=${encodeURIComponent(username)}`);
          const j = await r.json();
          if (j.ok) holdings = j.holdings || j.positions || [];
        } catch (_) {}

        if (!latestStocksBySymbol || Object.keys(latestStocksBySymbol).length === 0) {
          try { await loadAllStocks(); } catch (_) {}
        }

        const norm = [];
        for (const h of holdings) {
          const sym = String(h.symbol || h.ticker || h.stock || "").trim().toUpperCase();
          const shares = Number(h.shares ?? h.qty ?? h.amount ?? h.amt ?? 0);
          if (!sym || !Number.isFinite(shares) || shares <= 0) continue;
          norm.push({ sym, shares });
        }

        if (!norm.length) {
          holdingsEl.textContent = "None";
          mvEl.textContent = "$0.00";
          nwEl.textContent = `$${(Number(latestBalance)||0).toFixed(2)}`;
          latestYouHave = 0;
          const yh0 = document.getElementById("youHaveShares");
          if (yh0) yh0.textContent = "0";
          updateTxnLine();
          return;
        }

        norm.sort((a,b) => a.sym.localeCompare(b.sym));
        holdingsEl.textContent = norm.map(h => `${h.sym}: ${Math.trunc(h.shares)}`).join(", ");

        let mv = 0;
        for (const h of norm) {
          const s = latestStocksBySymbol[h.sym];
          const price = s ? Number(s.price) : 0;
          if (Number.isFinite(price)) mv += price * h.shares;
        }
        mvEl.textContent = `$${mv.toFixed(2)}`;
        nwEl.textContent = `$${((Number(latestBalance)||0) + mv).toFixed(2)}`;

        // Update "You have" for this symbol
        latestYouHave = 0;
        for (const h of norm) {
          if (h.sym === String(symbol).trim().toUpperCase()) {
            latestYouHave = Math.trunc(h.shares);
            break;
          }
        }
        const yh = document.getElementById("youHaveShares");
        if (yh) yh.textContent = String(latestYouHave);
        updateTxnLine();

      }

      async function doTrade(side) {
        const qtyRaw = document.getElementById("tradeQty")?.value;
        const qty = parseInt(qtyRaw, 10);

        if (!username) return setTradeMsg("Missing username.", false);
        if (!symbol) return setTradeMsg("Missing symbol.", false);
        if (!Number.isFinite(qty) || qty <= 0) return setTradeMsg("Enter a positive quantity.", false);

        const endpoint = side === "sell" ? "/sell" : "/buy";

        setTradeMsg("Sending...", true);
        let j;
        try {
          const r = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, symbol, qty }),
          });
          j = await r.json();
        } catch (e) {
          return setTradeMsg("Network error.", false);
        }

        if (j && j.ok) {
          setTradeMsg(side === "sell" ? "Sold." : "Bought.", true);
          await loadUser();
          await loadAllStocks();
          await loadPortfolioSummary();
          await loadStock();
          await loadHistory();
        } else {
          setTradeMsg((j && (j.error || j.message)) || "Trade failed.", false);
        }
      }

      async function loadStock() {
        if (!symbol) return;

        const r = await fetch(`/stock?symbol=${encodeURIComponent(symbol)}`);
        const j = await r.json();

        if (!j.ok || !j.stock) return;

        document.getElementById("stockName").textContent = j.stock.name || "-";
        document.getElementById("stockIndustry").textContent = j.stock.industry || "-";
        document.getElementById("stockPrice").textContent = fmtMoney(j.stock.price);
        latestStockPrice = Number(j.stock.price);
        updateTxnLine();

        const ch = fmtChange(j.stock.price, j.stock.prev_price);
        const chEl = document.getElementById("stockChange");
        chEl.textContent = ch.text;
        chEl.className = ch.cls;
      }


      async function loadHistory() {
        if (!symbol) return;
        if (typeof Plotly === "undefined") return;

        const r = await fetch(`/stock_history?symbol=${encodeURIComponent(symbol)}&limit=120`);
        const j = await r.json();
        if (!j.ok || !Array.isArray(j.series)) return;

        const x = j.series.map(p => p.time_string || String(p.time));
        const y = j.series.map(p => p.price);

        const trace = { x, y, mode: "lines", name: symbol, line: { width: 3 } };
        const layout = {
          margin: { l: 46, r: 18, t: 12, b: 46 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0.25)",
          font: {
            family: 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"',
            size: 12,
            color: "rgba(255,255,255,0.86)"
          },
          xaxis: {
            title: { text: "Time", font: { size: 12, color: "rgba(255,255,255,0.72)" } },
            type: "category",
            showgrid: true,
            gridcolor: "rgba(255,255,255,0.08)",
            zeroline: false,
            linecolor: "rgba(255,255,255,0.14)",
            tickfont: { color: "rgba(255,255,255,0.70)" }
          },
          yaxis: {
            title: { text: "Price", font: { size: 12, color: "rgba(255,255,255,0.72)" } },
            showgrid: true,
            gridcolor: "rgba(255,255,255,0.08)",
            zeroline: false,
            linecolor: "rgba(255,255,255,0.14)",
            tickfont: { color: "rgba(255,255,255,0.70)" }
          },
          hovermode: "x unified",
          showlegend: false
        };

        Plotly.react("chart", [trace], layout, { displayModeBar: false, responsive: true });
      }

      document.getElementById("buyBtn").addEventListener("click", () => doTrade("buy"));
      document.getElementById("sellBtn").addEventListener("click", () => doTrade("sell"));
      document.getElementById("tradeQty").addEventListener("input", updateTxnLine);

      loadUser();
      loadStock();
      loadAllStocks();
      loadPortfolioSummary();
      loadHistory();
      updateTxnLine();
      setInterval(loadUser, 2000);
      setInterval(loadAllStocks, 2000);
      setInterval(loadPortfolioSummary, 2000);
      setInterval(loadStock, 2000);
      setInterval(loadHistory, 5000);
    </script>
  		</main>
	</body>
</html>
