<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Mega Monopoly 5 - Stock</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <h1 id="stockTicker">Stock</h1>
    <p><a href="/" id="backLink">Back</a></p>

    <p>Welcome, <strong id="u">?</strong></p>
    <p>It is <strong id="t">-</strong></p>
    <p>Balance: <strong id="bal">-</strong></p>

    <hr>

    <p><strong id="stockName">-</strong></p>
    <p>Industry: <span id="stockIndustry">-</span></p>
    <p>
      Price: <span id="stockPrice">-</span>
      <span id="stockChange" class=""></span>
    </p>

    <div id="chart" style="width: 100%; height: 360px;"></div>

    <script>
      const params = new URLSearchParams(location.search);
      const username = params.get("username") || "";
      const symbol = params.get("stock") || ""; // dashboard uses ?stock=TICKER

      document.getElementById("u").textContent = username || "?";
      document.getElementById("stockTicker").textContent = symbol || "Stock";

      const back = document.getElementById("backLink");
      back.href = username ? `/dashboard.html?username=${encodeURIComponent(username)}` : "/";

      function fmtMoney(x) {
        if (typeof x !== "number" || !isFinite(x)) return "-";
        return `$${x.toFixed(2)}`;
      }

      function fmtChange(price, prev) {
        if (typeof price !== "number" || typeof prev !== "number" || !isFinite(price) || !isFinite(prev) || prev === 0) {
          return { text: "", cls: "" };
        }
        const pct = ((price - prev) / prev) * 100;
        const up = pct >= 0;
        const arrow = up ? "⌃" : "⌄";
        return { text: ` ${arrow} ${Math.abs(pct).toFixed(1)}%`, cls: up ? "stock-change up" : "stock-change down" };
      }

      async function loadUser() {
        if (!username) return;

        const r = await fetch(`/user?username=${encodeURIComponent(username)}`);
        const j = await r.json();

        if (j.ok) {
          document.getElementById("bal").textContent = j.balance;
          document.getElementById("t").textContent = j.time_string;
        } else {
          document.getElementById("bal").textContent = "unknown";
          document.getElementById("t").textContent = "-";
        }
      }

      async function loadStock() {
        if (!symbol) return;

        const r = await fetch(`/stock?symbol=${encodeURIComponent(symbol)}`);
        const j = await r.json();

        if (!j.ok || !j.stock) return;

        document.getElementById("stockName").textContent = j.stock.name || "-";
        document.getElementById("stockIndustry").textContent = j.stock.industry || "-";
        document.getElementById("stockPrice").textContent = fmtMoney(j.stock.price);

        const ch = fmtChange(j.stock.price, j.stock.prev_price);
        const chEl = document.getElementById("stockChange");
        chEl.textContent = ch.text;
        chEl.className = ch.cls;
      }


      async function loadHistory() {
        if (!symbol) return;
        if (typeof Plotly === "undefined") return;

        const r = await fetch(`/stock_history?symbol=${encodeURIComponent(symbol)}&limit=120`);
        const j = await r.json();
        if (!j.ok || !Array.isArray(j.series)) return;

        const x = j.series.map(p => p.time_string || String(p.time));
        const y = j.series.map(p => p.price);

        const trace = { x, y, mode: "lines+markers", name: symbol };
        const layout = {
          margin: { l: 40, r: 15, t: 10, b: 40 },
          xaxis: { title: "Time", type: "category" },
          yaxis: { title: "Price" }
        };

        Plotly.react("chart", [trace], layout, { displayModeBar: false, responsive: true });
      }

      loadUser();
      loadStock();
      loadHistory();
      setInterval(loadUser, 2000);
      setInterval(loadStock, 2000);
      setInterval(loadHistory, 5000);
    </script>
  </body>
</html>
